import _ from "lodash";
import { viewTypes } from ".";
import { defaultObjectProperties, mergeArrayWithSchema, textSchema } from "..";
import { DataElementSchema } from "../../../../../domain/autogenerated-forms-configurator/entities/DataElement";
import { SectionSchema } from "../../../../../domain/autogenerated-forms-configurator/entities/Section";

const styleBgColor = {
    backgroundColor: {
        type: "string",
    },
};

export const sectionSchema = (
    sections: SectionSchema[],
    dataElements: DataElementSchema[],
    constantCodes: string[]
) => {
    const dataElementCodes = _(dataElements)
        .map(dataElement => dataElement.dataElementCode)
        .compact()
        .value();
    const columnsDescriptions = _(sections)
        .flatMap(section => section.columnsDescriptions)
        .uniq()
        .value();

    const sectionProperties = {
        indicators: {
            type: "object",
            additionalProperties: {
                type: "object",
                properties: {
                    position: {
                        type: "object",
                        properties: {
                            dataElement: { type: "string", enum: dataElementCodes },
                            direction: { type: "string", enum: ["after", "before"] },
                        },
                        required: ["direction", "dataElement"],
                    },
                },
            },
        },
        columnsDescriptions: mergeArrayWithSchema(columnsDescriptions, textSchema(constantCodes)),
        groupDescriptions: {
            type: "object",
            additionalProperties: {
                type: "object",
                properties: {
                    code: { enum: constantCodes },
                },
            },
        },
        disableComments: {
            type: "boolean",
        },
        sortRowsBy: {
            type: "string",
        },
        viewType: {
            enum: viewTypes,
        },
        texts: defaultObjectProperties({
            properties: {
                footer: textSchema(constantCodes),
                header: textSchema(constantCodes),
                rowTotals: textSchema(constantCodes),
                totals: textSchema(constantCodes),
                name: textSchema(constantCodes),
            },
        }),
        toggle: defaultObjectProperties({
            properties: {
                type: {
                    enum: ["dataElement", "dataElementExternal"],
                },
                code: {
                    enum: dataElementCodes,
                },
                condition: {
                    type: "string",
                },
            },
        }),
        toggleMultiple: {
            type: "array",
            items: defaultObjectProperties({
                type: "object",
                properties: {
                    dataElement: { enum: dataElementCodes },
                    condition: { type: "string" },
                },
            }),
        },
        titleVariant: {
            enum: ["h1", "h2", "h3", "h4", "h5", "h6"],
        },
        tabs: defaultObjectProperties({
            properties: {
                active: {
                    const: true,
                },
                order: {
                    type: "number",
                },
            },
        }),
        styles: defaultObjectProperties({
            properties: {
                rows: defaultObjectProperties({ properties: styleBgColor }),
                columns: defaultObjectProperties({ properties: styleBgColor }),
                title: defaultObjectProperties({ properties: styleBgColor }),
                totals: defaultObjectProperties({ properties: styleBgColor }),
            },
        }),
        totals: {
            type: "object",
            properties: {
                dataElementsCodes: { type: "array" },
                formula: { type: "string" },
                formulas: {
                    type: "object",
                    additionalProperties: { type: "object", properties: { formula: { type: "string" } } },
                },
            },
        },
    };

    const calculateTotalsValidation = mergeArrayWithSchema(dataElementCodes, {
        properties: {
            totalDeCode: { type: "string", enum: _(dataElementCodes).compact().value() },
            disabled: "boolean",
        },
    });

    return {
        type: "object",
        minProperties: 1,
        properties: sectionProperties,
        if: { properties: { viewType: { const: "grid-with-periods" } } },
        then: {
            properties: {
                periods: defaultObjectProperties({
                    properties: {
                        type: { const: "relative-interval" },
                        endOffset: { type: "number" },
                        startOffset: { type: "number" },
                    },
                }),
                ...sectionProperties,
            },
        },
        else: {
            if: { properties: { viewType: { const: "grid-with-totals" } } },
            then: {
                properties: {
                    calculateTotals: {
                        type: "object",
                        properties: { ...calculateTotalsValidation },
                        additionalProperties: false,
                    },
                    ...sectionProperties,
                },
            },
            else: {
                if: { properties: { viewType: { const: "grid-with-subnational-ous" } } },
                then: {
                    properties: {
                        calculateTotals: {
                            type: "object",
                            properties: { ...calculateTotalsValidation },
                            additionalProperties: false,
                        },
                        subNationalDataset: {
                            type: "string",
                        },
                        ...sectionProperties,
                    },
                },
                else: {
                    properties: sectionProperties,
                },
            },
        },
    };
};

import React, { useEffect, useMemo, useState } from "react";
import styled from "styled-components";
import { Button } from "@material-ui/core";
import { useAppContext } from "../../contexts/app-context";
import { DataSet } from "../../../domain/autogenerated-forms-configurator/entities/DataSet";
import _ from "lodash";
import { ConfiguratorFilter, Filters } from "./Filters";
import { Editor } from "./Editor";

const AutogeneratedFormConfigurator: React.FC = () => {
    const { compositionRoot } = useAppContext();
    const [filters, setFilters] = useState(() => getEmptyDataValuesFilter());

    const [dataSets, setDataSets] = useState<DataSet[]>([]);
    const [value, setValue] = useState<string | undefined>();
    const [isJSONValid, setJsonValidity] = useState<boolean>(false);

    const { code, sections } = useMemo(() => {
        const selectedDS = _.find(dataSets, { id: filters.dataSetId });
        if (!selectedDS) return { code: "", sections: [] };

        setValue(!value ? "{}" : value);

        return { code: selectedDS.code, sections: selectedDS.sections };
    }, [dataSets, filters.dataSetId, value]);

    useEffect(() => {
        compositionRoot.dataStoreConfig.getDataSets().then(dataSets => setDataSets(dataSets));
    }, [compositionRoot.dataStoreConfig]);

    useEffect(() => {
        compositionRoot.dataStoreConfig
            .getFormConfig(code)
            .then(config => code !== "" && setValue(JSON.stringify(config, null, 4)));
    }, [compositionRoot.dataStoreConfig, dataSets, code]);

    function handleEditorValidation(markers: any) {
        if (_.isEmpty(markers)) {
            setJsonValidity(true);
        } else {
            setJsonValidity(false);
        }
    }

    return (
        <Container>
            <Filters values={filters} onChange={setFilters} options={{ dataSets }} />

            <Editor
                dsCode={code}
                handleEditorValidation={handleEditorValidation}
                json={value}
                onChange={setValue}
                sections={sections}
            />

            <ButtonGroup>
                <Button
                    color="primary"
                    variant="contained"
                    onClick={() => compositionRoot.dataStoreConfig.saveFormConfig(code, JSON.parse(value ?? ""))}
                    disabled={!filters.dataSetId || !isJSONValid || !value}
                >
                    Save
                </Button>
                <Button color="default" variant="contained">
                    Cancel
                </Button>
            </ButtonGroup>
        </Container>
    );
};

export default React.memo(AutogeneratedFormConfigurator);

const Container = styled.div`
    padding: 20px;
`;

const ButtonGroup = styled.div`
    width: 50%;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0 1rem;
`;

function getEmptyDataValuesFilter(): ConfiguratorFilter {
    return {
        dataSetId: "",
    };
}

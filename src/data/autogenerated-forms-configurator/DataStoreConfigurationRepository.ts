import { DataStoreConfigurationRepository } from "../../domain/autogenerated-forms-configurator/repositories/DataStoreConfigurationRepository";
import { D2Api } from "../../types/d2-api";
import { DataSet, AutogenConfigSchema } from "../../domain/autogenerated-forms-configurator/entities/DataSet";
import _ from "lodash";
import { Namespaces } from "../common/clients/storage/Namespaces";
import { Maybe } from "../../utils/ts-utils";
import { AutogenConfig, Code } from "../../domain/autogenerated-forms-configurator/entities/AutogenConfig";

export class Dhis2DataStoreConfigurationRepository implements DataStoreConfigurationRepository {
    constructor(private api: D2Api) {}

    async getFormConfig(namespace: string): Promise<AutogenConfig> {
        return (
            (await this.api.dataStore(Namespaces.D2_AUTOGEN_FORMS).get<AutogenConfig>(namespace).getData()) ?? {
                categoryCombinations: {},
                dataElements: {},
                dataSets: {},
            }
        );
    }

    async saveFormConfig(namespace: string, config: AutogenConfig): Promise<void> {
        return await this.api.dataStore(Namespaces.D2_AUTOGEN_FORMS).save(namespace, config).getData();
    }

    async getDataSets(): Promise<DataSet[]> {
        const dataSets = await this.getMetadata();

        return dataSets
            .filter(dataSet => {
                const hasDSCode = dataSet.code !== undefined;
                const hasSectionCode = !_(dataSet.sections)
                    .map(section => section.code)
                    .compact()
                    .isEmpty();

                return hasDSCode && hasSectionCode;
            })
            .map(dataSet => ({
                ...dataSet,
                dataSetElements: _(dataSet.dataSetElements)
                    .filter(
                        dataSetElement =>
                            _.size(dataSetElement.categoryCombo) > 0 || _.size(dataSetElement.dataElement) > 0
                    )
                    .value(),
            }));
    }

    private async getMetadata() {
        const { objects: dataSets } = await this.api.models.dataSets
            .get({
                fields: dataSetFields,
                filter: {
                    name: {
                        ilike: "NHWA",
                        like: "MAL",
                    },
                },
                paging: false,
                rootJunction: "OR",
            })
            .getData();

        return dataSets;
    }

    async getSelectedDataSet(dataSets: DataSet[], dataSetCode: Maybe<Code>): Promise<AutogenConfigSchema> {
        const dataSet = _.find(dataSets, { code: dataSetCode });
        if (!dataSetCode || !dataSet)
            return { sections: [], categoryComboCodes: [], dataElements: [], constantCodes: [] };

        const constantCodes = await this.getConstantCodes();
        const dataElements = this.getDataElements(dataSet);
        const sections = this.getSections(dataSet);
        const categoryComboCodes = this.getCategoryComboCodes(dataSet);

        return {
            categoryComboCodes: categoryComboCodes,
            constantCodes: constantCodes,
            dataElements: dataElements,
            sections: sections,
        };
    }

    private getSections(dataSet: DataSet) {
        return dataSet.sections.map(section => {
            const columnsDescriptions = _(section.dataElements)
                .flatMap(dataElement => dataElement.categoryCombo?.categoryOptionCombos.map(coc => coc.name))
                .compact()
                .uniq()
                .value();

            return {
                code: section.code,
                columnsDescriptions: columnsDescriptions,
            };
        });
    }

    private getDataElements(dataSet: DataSet) {
        const sectionDEs = _(dataSet.sections)
            .flatMap(section =>
                section.dataElements.map(dataElement => ({
                    dataElementCode: dataElement.code,
                    optionSetCode: dataElement.optionSet?.code,
                }))
            )
            .value();

        const dataSetDEs = _(dataSet.dataSetElements)
            .map(dataSetElement => ({
                dataElementCode: dataSetElement.dataElement?.code,
                optionSetCode: dataSetElement.dataElement.optionSet?.code,
            }))
            .value();

        const dataElements = _.uniqBy(_.concat(sectionDEs, dataSetDEs), "dataElementCode");
        return dataElements;
    }

    private getCategoryComboCodes(dataSet: DataSet) {
        return _(dataSet.dataSetElements)
            .map(dataSetElement => dataSetElement.categoryCombo?.code)
            .compact()
            .uniq()
            .value();
    }

    private async getConstantCodes(): Promise<string[]> {
        const { constants } = await this.api.metadata.get({ constants: { fields: { code: true } } }).getData();

        return constants.filter(constant => constant.code).map(constant => constant.code);
    }
}

const dataSetFields = {
    name: true,
    code: true,
    sections: {
        code: true,
        dataElements: {
            code: true,
            optionSet: {
                code: true,
            },
            categoryCombo: {
                code: true,
                categoryOptionCombos: {
                    code: true,
                    name: true,
                },
            },
        },
    },
    dataSetElements: {
        dataElement: {
            code: true,
            optionSet: {
                code: true,
            },
        },
        categoryCombo: {
            code: true,
            categoryCombo: {
                categoryOptionCombos: {
                    code: true,
                    name: true,
                },
            },
        },
    },
};
